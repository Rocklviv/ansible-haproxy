---

- name: Check if conf file exists
  stat:
    path: /etc/haproxy/haproxy.cfg
  register: st
  failed_when: st.stat.exists != True

- name: "Ensure haproxy.cfg contains 'ansible managed' line"
  lineinfile:
    path: /etc/haproxy/haproxy.cfg
    line: "# Ansible managed: Do NOT edit this file manually!"
    state: present
  check_mode: yes
  register: contents
  failed_when: (contents | changed) or (contents | failed)

- name: Check if 503 error file exists
  stat:
    path: /etc/haproxy/errors/503.http
  register: st
  failed_when: st.stat.exists != True

- name: Check if haproxy is running (status page test)
  uri:
    url: "http://{{ haproxy_stats_address }}:{{ haproxy_stats_port }}/"
    status_code: 401
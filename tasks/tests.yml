---

- name: Check if conf file exists
  stat:
    path: /etc/haproxy/haproxy.cfg
  register: st
  failed_when: st.stat.exists != True

- name: "Ensure haproxy.cfg contains 'ansible managed' line"
  lineinfile:
    path: /etc/haproxy/haproxy.cfg
    line: "# Ansible managed: Do NOT edit this file manually!"
    state: present
  check_mode: yes
  register: contents
  failed_when: (contents | changed) or (contents | failed)

- name: Check if error dir exists
  stat:
    path: /etc/haproxy/errors
  register: st
  failed_when: st.stat.isdir != True

- name: Check if haproxy is running
  command: systemctl status haproxy
  changed_when: false
  register: hpstatus
  failed_when: hpstatus | failed

- name: Check if haproxy is running (status page test)
  uri:
    url: http://localhost:1936/
    status_code: 401